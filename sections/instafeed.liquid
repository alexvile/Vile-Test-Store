{{ 'instafeed.css' | asset_url | stylesheet_tag }}

{% assign feed = shop.metafields.abrio_instagram.feed.value %}
{% assign max_posts = section.settings.max_posts | default: feed.size %}
{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
  .section-{{ section.id }}-padding .instafeed__text {
    --mb-alignment: {{ section.settings.mb_alignment }};
    --dt-alignment: {{ section.settings.dt_alignment }};
  }
  .section-{{ section.id }}-padding {
    --mb-gap:  {{ section.settings.mb_space_between }}px;
    --dt-gap: {{ section.settings.dt_space_between }}px;
  }
{%- endstyle -%}
{% comment %} aspect ratios - mobile and desktop {% endcomment %}
{% comment %} preload for slow internet {% endcomment %}
{% comment %} placeholders? {% endcomment %}
{% comment %} text block {% endcomment %}
{% comment %} section padding {% endcomment %}
{% comment %} max-width for text ?{% endcomment %}
<div class="section-{{ section.id }}-padding instafeed__wrapper page-width{% if section.settings.show_aside_at_dt %} instafeed__aside-text{% endif %}">
  {% if section.settings.heading != blank
    or section.settings.description != blank
    or section.settings.link_label != blank
  %}
    <div class="instafeed__text">
      {%- if section.settings.heading != blank -%}
        <h2>{{- section.settings.heading -}}</h2>
      {%- endif -%}
      {%- if section.settings.description != blank -%}
        <div>
          {{- section.settings.description -}}
        </div>
      {%- endif -%}
      {% if section.settings.link_label != blank and section.settings.link_to_account != blank %}
        <a
          href="{{ section.settings.link_to_account | escape }}"
          target="_blank"
          rel="noopener noreferrer"
        >
          {{ section.settings.link_label }}
        </a>
      {% endif %}
    </div>
  {% endif %}
  {% if feed.size > 0 %}
    <ul
      class="instafeed__list"
      style="
        --mobile-cols: {{ section.settings.mobile_columns }};
        --desktop-cols: {{ section.settings.desktop_columns }};
      "
    >
      {% for post in feed limit: max_posts %}
        <li class="instafeed__post{% if section.settings.rounded_corners %} rounded-corners{% endif %}">
          {% capture link_in_post_media %}
            {%- if section.settings.post_link == 'post' -%}
              <a class="direct-link" href="{{ post.permalink }}" target="_blank"></a>
              <div class="link-overlay"></div>
            {%- endif -%}
          {% endcapture %}
          {% case post.media_type %}
            {% when 'IMAGE' %}
              <div class="media-wrapper media-wrapper--image">
                <img
                  src="{{ post.media_url }}"
                  alt="{{ post.caption | escape }}"
                  loading="lazy"
                >
                {{- link_in_post_media -}}
              </div>

            {% when 'VIDEO' %}
              <div class="media-wrapper media-wrapper--video">
                <video
                  {% if section.settings.video_autoplay %}
                    autoplay
                  {% endif %}
                  {% if section.settings.video_playsinline %}
                    playsinline
                  {% endif %}
                  {% if section.settings.video_controls %}
                    controls
                  {% endif %}
                  {% if section.settings.video_loop %}
                    loop
                  {% endif %}
                  muted
                  {% if post.thumbnail_url != blank %}
                    poster="{{ post.thumbnail_url }}"
                  {% endif %}
                >
                  <source src="{{ post.media_url }}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
                {{- link_in_post_media -}}
              </div>

            {% when 'CAROUSEL_ALBUM' %}
              <div class="media-wrapper carousel-icon">
                <img src="{{ post.media_url }}" alt="{{ post.caption | escape }}" loading="lazy">
                <span class="carousel-indicator">
                  {{- 'icon-instafeed-carousel.svg' | inline_asset_content -}}
                </span>
                {{- link_in_post_media -}}
              </div>

            {% else %}
              <p>Unknown content type</p>
          {%- endcase -%}
          {%- if section.settings.show_caption -%}
            <p class="caption">{{- post.caption -}}</p>
          {%- endif -%}
          {% if section.settings.date_format != 'none' or section.settings.post_link == 'link' %}
            <div class="instafeed__post-meta">
              {%- unless section.settings.date_format == 'none' -%}
                <small class="timestamp">
                  {{ post.timestamp | date: section.settings.date_format }}
                </small>
              {%- endunless -%}
              {%- if section.settings.post_link == 'link' -%}
                <a class="direct-link" href="{{ post.permalink }}" target="_blank">Go to the post</a>
              {%- endif -%}
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="instafeed__no-posts">
      <div class="placeholder">
        <svg width="64" height="64" fill="none" stroke="#ccc" stroke-width="1.5">
          <rect x="8" y="8" width="48" height="48" rx="8" stroke-dasharray="4 2"/>
          <line x1="8" y1="8" x2="56" y2="56" />
          <line x1="56" y1="8" x2="8" y2="56" />
        </svg>
        <p>The Instagram feed is currently unavailableðŸ˜”.</p>
        <p>It may take a moment to refresh or load the latest posts.</p>
        <p>If the issue persists, please contact support.</p>
      </div>
    </div>
  {% endif %}
</div>

{% schema %}
{
  "name": "Instafeed",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Text section"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "This is a placeholder for a headline"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>"
    },
    {
      "type": "url",
      "id": "link_to_account",
      "label": "Link to IG account"
    },
    {
      "type": "text",
      "id": "link_label",
      "label": "Link label",
      "default": "Discover on instagram"
    },
    {
      "type": "text_alignment",
      "id": "mb_alignment",
      "label": "Text alignment (mobile)",
      "default": "center"
    },
    {
      "type": "text_alignment",
      "id": "dt_alignment",
      "label": "Text alignment (desktop)",
      "default": "center"
    },
    {
      "type": "checkbox",
      "id": "show_aside_at_dt",
      "label": "Show aside (desktop)",
      "default": false
    },
    {
      "type": "header",
      "content": "Main settings"
    },
    {
      "type": "range",
      "id": "max_posts",
      "label": "Max posts to show",
      "min": 1,
      "max": 24,
      "step": 1,
      "default": 8
    },
    {
      "type": "checkbox",
      "id": "show_caption",
      "label": "Show caption",
      "default": false
    },
    {
      "type": "select",
      "id": "date_format",
      "label": "Date format",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "%d.%m.%Y", "label": "DD.MM.YYYY" },
        { "value": "%d %B %Y", "label": "Day Month Year" },
        { "value": "%B %d", "label": "Month Day" }
      ],
      "default": "%d.%m.%Y"
    },
    {
      "type": "select",
      "id": "post_link",
      "label": "Link to post",
      "info": "When you select the 'Post media' option, the controls on the video will be unavailable",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "post", "label": "Post media" },
        { "value": "link", "label": "Link under the post" }
      ],
      "default": "post"
    },
    {
      "type": "checkbox",
      "id": "rounded_corners",
      "label": "Rounded corners",
      "default": false
    },
    {
      "type": "header",
      "content": "Video settings"
    },
    {
      "type": "checkbox",
      "id": "video_autoplay",
      "label": "Autoplay video",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "video_controls",
      "label": "Show video controls (play, volume, etc.)",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "video_playsinline",
      "label": "Play video inline (prevent fullscreen on mobile)",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "video_loop",
      "label": "Loop video (replay automatically)",
      "default": true
    },
    {
      "type": "header",
      "content": "Layout (columns)"
    },
    {
      "type": "select",
      "id": "mobile_columns",
      "label": "Mobile",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" }
      ],
      "default": "2"
    },
    {
      "type": "select",
      "id": "desktop_columns",
      "label": "Desktop",
      "options": [
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "3"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Instafeed"
    }
  ]
}
{% endschema %}
